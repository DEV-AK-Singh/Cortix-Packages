generator client {
  provider = "prisma-client"
  output   = "../generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String       @id @default(uuid())
  email     String       @unique
  name      String?
  avatar    String?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  accounts  Account[]
  repos     Repository[]
  projects  Project[]
}

model Account {
  id                String       @id @default(uuid())
  userId            String
  provider          AuthProvider
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  createdAt         DateTime     @default(now())
  user              User         @relation(fields: [userId], references: [id])

  @@unique([provider, providerAccountId])
}

enum AuthProvider {
  GITHUB
  GOOGLE
}

model Repository {
  id          String       @id @default(uuid())
  userId      String
  provider    RepoProvider
  repoId      String
  name        String
  description String?
  owner       String       @default("")
  fullName    String
  private     Boolean
  url         String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt
  user        User         @relation(fields: [userId], references: [id])

  @@unique([provider, repoId])
}

enum RepoProvider {
  GITHUB
}

enum ProjectStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model Branch {
  id        String  @id @default(uuid())
  name      String
  isDefault Boolean @default(false)
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  @@unique([projectId, name])
}

enum ProjectStage {
  CREATED
  ANALYSIS_QUEUED
  ANALYZING
  ANALYSIS_DONE
  INFRA_PLANNING
  INFRA_PLANNED
  INFRA_QUEUED
  INFRA_GENERATING
  INFRA_DONE
  DEPLOY_QUEUED
  DEPLOYING
  DEPLOYED
  FAILED
}

model Project {
  id              String           @id @default(uuid())
  userId          String
  name            String
  description     String?
  repoProvider    RepoProvider
  repoOwner       String
  repoName        String
  repoId          String
  defaultBranch   String
  stage           ProjectStage     @default(CREATED)
  status          ProjectStatus    @default(ACTIVE)
  branches        Branch[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  user            User             @relation(fields: [userId], references: [id])
  analysisJobs    AnalysisJob[]
  analysisResults AnalysisResult[]
  infrastructurePlan InfrastructurePlan?

  @@unique([repoProvider, repoId, defaultBranch])
}

enum AnalysisStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model AnalysisJob {
  id        String         @id @default(uuid())
  projectId String
  status    AnalysisStatus @default(PENDING)
  result    Json? // Stores the full CumulativeReport
  error     String?
  startedAt DateTime?
  endedAt   DateTime?
  createdAt DateTime       @default(now())
  project   Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model AnalysisResult {
  id             String   @id @default(uuid())
  projectId      String   @unique
  avgHealthScore Float    @default(0)
  languages      Json     @default("{}")
  mainFrameworks String[]
  services       Json     @default("[]")
  infrastructure Json     @default("{}")
  globalHealth   Json     @default("{}")
  version        String   @default("v2-cumulative")
  updatedAt      DateTime @default(now()) @updatedAt
  createdAt      DateTime @default(now())
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model InfrastructurePlan {
  id                 String           @id @default(uuid())
  projectId          String           @unique
  deploymentStrategy String           // DOCKER_SINGLE | DOCKER_COMPOSE
  services           Json             // Array of ServicePlan objects
  network            Json             // internalDomain, exposedPorts
  version            String           @default("1.0")
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  project            Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}